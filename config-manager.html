<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Gestionnaire de Configuration SIEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        .card { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); }
    </style>
</head>
<body class="min-h-screen text-white">
    <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <div class="glass rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2">üîß Gestionnaire de Configuration</h1>
                    <p class="text-gray-400">Gestion centralis√©e des cl√©s API et param√®tres SIEM</p>
                </div>
                <div class="flex space-x-4">
                    <button onclick="loadConfigs()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                        üîÑ Actualiser
                    </button>
                    <button onclick="createBackup()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                        üíæ Sauvegarder
                    </button>
                    <a href="index.html" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors">
                        ‚Üê Retour SIEM
                    </a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Gestion des APIs -->
            <div class="card rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-6 flex items-center">
                    üîë Cl√©s API
                    <span id="api-count" class="ml-2 px-2 py-1 bg-blue-900 text-blue-300 text-xs rounded-full">0</span>
                </h2>

                <!-- Formulaire d'ajout -->
                <div class="bg-slate-800 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-white mb-4">Ajouter/Modifier une cl√© API</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Service</label>
                            <select id="api-service" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                                <option value="abuseipdb">üõ°Ô∏è AbuseIPDB</option>
                                <option value="virustotal">ü¶† VirusTotal</option>
                                <option value="shodan">üîç Shodan</option>
                                <option value="ipinfo">üìç IPinfo.io</option>
                                <option value="urlvoid">üåê URLVoid</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Cl√© API</label>
                            <input type="password" id="api-key" placeholder="Entrez la cl√© API..." 
                                   class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-400">
                        </div>
                        <button onclick="saveApiKey()" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                            üíæ Sauvegarder
                        </button>
                    </div>
                </div>

                <!-- Liste des APIs -->
                <div class="space-y-3" id="api-list">
                    <!-- Contenu g√©n√©r√© dynamiquement -->
                </div>
            </div>

            <!-- Param√®tres g√©n√©raux -->
            <div class="card rounded-xl p-6">
                <h2 class="text-xl font-semibold text-white mb-6 flex items-center">
                    ‚öôÔ∏è Param√®tres
                    <span id="settings-count" class="ml-2 px-2 py-1 bg-purple-900 text-purple-300 text-xs rounded-full">0</span>
                </h2>

                <!-- Param√®tres rapides -->
                <div class="space-y-4 mb-6">
                    <div class="bg-slate-800 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">D√©lai entre requ√™tes (ms)</label>
                        <input type="number" id="rate-limit" value="1000" min="100" max="5000" 
                               class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                    </div>
                    
                    <div class="bg-slate-800 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Taille max analyse en lot</label>
                        <input type="number" id="bulk-size" value="100" min="10" max="1000" 
                               class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                    </div>
                    
                    <div class="bg-slate-800 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Niveau de notification</label>
                        <select id="notification-level" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                            <option value="low">üîµ Faible</option>
                            <option value="medium">üü° Moyen</option>
                            <option value="high">üü† √âlev√©</option>
                            <option value="critical">üî¥ Critique uniquement</option>
                        </select>
                    </div>
                    
                    <button onclick="saveSettings()" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                        üíæ Sauvegarder les param√®tres
                    </button>
                </div>

                <!-- Statistiques -->
                <div class="bg-slate-800 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-white mb-4">üìä Statistiques</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <div class="text-gray-400">APIs actives</div>
                            <div id="stat-apis" class="text-xl font-bold text-green-400">-</div>
                        </div>
                        <div>
                            <div class="text-gray-400">Taille DB</div>
                            <div id="stat-size" class="text-xl font-bold text-blue-400">-</div>
                        </div>
                        <div class="col-span-2">
                            <div class="text-gray-400">Derni√®re mise √† jour</div>
                            <div id="stat-update" class="text-sm text-gray-300">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions avanc√©es -->
        <div class="card rounded-xl p-6 mt-8">
            <h2 class="text-xl font-semibold text-white mb-6">üîß Actions avanc√©es</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="testAllApis()" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                    üß™ Tester toutes les APIs
                </button>
                <button onclick="exportConfig()" class="px-4 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg transition-colors">
                    üì§ Exporter la config
                </button>
                <button onclick="cleanupDatabase()" class="px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                    üóëÔ∏è Nettoyer la DB
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages" class="fixed top-4 right-4 space-y-2 z-50"></div>
    </div>

    <script>
        // Variables globales
        let apis = [];
        let settings = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadConfigs();
        });

        // Chargement des configurations
        async function loadConfigs() {
            try {
                // Charger les APIs
                const apiResponse = await fetch('config/api.php?path=apis');
                const apiData = await apiResponse.json();
                
                if (apiData.success) {
                    apis = apiData.data;
                    displayApis();
                }

                // Charger les param√®tres
                const settingsResponse = await fetch('config/api.php?path=settings');
                const settingsData = await settingsResponse.json();
                
                if (settingsData.success) {
                    settings = settingsData.data;
                    displaySettings();
                }

                // Charger les statistiques
                const statsResponse = await fetch('config/api.php?path=stats');
                const statsData = await statsResponse.json();
                
                if (statsData.success) {
                    displayStats(statsData.data);
                }

                showMessage('Configuration charg√©e avec succ√®s', 'success');
            } catch (error) {
                showMessage('Erreur lors du chargement: ' + error.message, 'error');
            }
        }

        // Affichage des APIs
        function displayApis() {
            const apiList = document.getElementById('api-list');
            const apiCount = document.getElementById('api-count');
            
            apiCount.textContent = apis.length;
            apiList.innerHTML = '';

            apis.forEach(api => {
                const statusColor = api.is_active ? 'text-green-400' : 'text-red-400';
                const statusIcon = api.is_active ? '‚úÖ' : '‚ùå';
                
                apiList.innerHTML += `
                    <div class="bg-slate-800 rounded-lg p-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${getServiceIcon(api.service_name)}</span>
                            <div>
                                <div class="font-medium text-white">${api.service_name}</div>
                                <div class="text-sm text-gray-400">
                                    ${api.has_key ? 'üîë Configur√©' : '‚ùå Non configur√©'} ‚Ä¢ 
                                    <span class="${statusColor}">${statusIcon} ${api.is_active ? 'Actif' : 'Inactif'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="toggleApi('${api.service_name}', ${!api.is_active})" 
                                    class="px-3 py-1 ${api.is_active ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'} rounded text-sm">
                                ${api.is_active ? 'D√©sactiver' : 'Activer'}
                            </button>
                            <button onclick="deleteApi('${api.service_name}')" 
                                    class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        // Affichage des param√®tres
        function displaySettings() {
            const settingsCount = document.getElementById('settings-count');
            settingsCount.textContent = settings.length;

            // Remplir les champs avec les valeurs actuelles
            const rateLimitSetting = settings.find(s => s.setting_key === 'osint_rate_limit');
            if (rateLimitSetting) {
                document.getElementById('rate-limit').value = rateLimitSetting.setting_value;
            }

            const bulkSizeSetting = settings.find(s => s.setting_key === 'max_bulk_size');
            if (bulkSizeSetting) {
                document.getElementById('bulk-size').value = bulkSizeSetting.setting_value;
            }

            const notificationSetting = settings.find(s => s.setting_key === 'notification_level');
            if (notificationSetting) {
                document.getElementById('notification-level').value = notificationSetting.setting_value;
            }
        }

        // Affichage des statistiques
        function displayStats(stats) {
            document.getElementById('stat-apis').textContent = stats.active_apis || 0;
            document.getElementById('stat-size').textContent = formatBytes(stats.db_size || 0);
            document.getElementById('stat-update').textContent = stats.last_update || 'Jamais';
        }

        // Sauvegarde d'une cl√© API
        async function saveApiKey() {
            const service = document.getElementById('api-service').value;
            const apiKey = document.getElementById('api-key').value.trim();

            if (!apiKey) {
                showMessage('Veuillez entrer une cl√© API', 'error');
                return;
            }

            try {
                const response = await fetch('config/api.php?path=api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service, api_key: apiKey })
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage(`Cl√© API ${service} sauvegard√©e avec succ√®s`, 'success');
                    document.getElementById('api-key').value = '';
                    loadConfigs();
                } else {
                    showMessage('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Erreur lors de la sauvegarde: ' + error.message, 'error');
            }
        }

        // Sauvegarde des param√®tres
        async function saveSettings() {
            const settings = [
                { key: 'osint_rate_limit', value: document.getElementById('rate-limit').value },
                { key: 'max_bulk_size', value: document.getElementById('bulk-size').value },
                { key: 'notification_level', value: document.getElementById('notification-level').value }
            ];

            try {
                for (const setting of settings) {
                    await fetch('config/api.php?path=setting', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(setting)
                    });
                }

                showMessage('Param√®tres sauvegard√©s avec succ√®s', 'success');
                loadConfigs();
            } catch (error) {
                showMessage('Erreur lors de la sauvegarde: ' + error.message, 'error');
            }
        }

        // Basculer le statut d'une API
        async function toggleApi(service, isActive) {
            try {
                const response = await fetch('config/api.php?path=api/toggle', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service, is_active: isActive })
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage(`API ${service} ${isActive ? 'activ√©e' : 'd√©sactiv√©e'}`, 'success');
                    loadConfigs();
                } else {
                    showMessage('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Erreur: ' + error.message, 'error');
            }
        }

        // Supprimer une API
        async function deleteApi(service) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la cl√© API ${service} ?`)) {
                return;
            }

            try {
                const response = await fetch(`config/api.php?path=api&service=${service}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage(`Cl√© API ${service} supprim√©e`, 'success');
                    loadConfigs();
                } else {
                    showMessage('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Erreur: ' + error.message, 'error');
            }
        }

        // Cr√©er une sauvegarde
        async function createBackup() {
            try {
                const response = await fetch('config/api.php?path=backup', {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage('Sauvegarde cr√©√©e: ' + data.backup_path, 'success');
                } else {
                    showMessage('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Erreur: ' + error.message, 'error');
            }
        }

        // Nettoyer la base de donn√©es
        async function cleanupDatabase() {
            if (!confirm('√ätes-vous s√ªr de vouloir nettoyer la base de donn√©es ?')) {
                return;
            }

            try {
                const response = await fetch('config/api.php?path=cleanup', {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage('Base de donn√©es nettoy√©e', 'success');
                    loadConfigs();
                } else {
                    showMessage('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('Erreur: ' + error.message, 'error');
            }
        }

        // Fonctions utilitaires
        function getServiceIcon(service) {
            const icons = {
                'abuseipdb': 'üõ°Ô∏è',
                'virustotal': 'ü¶†',
                'shodan': 'üîç',
                'ipinfo': 'üìç',
                'urlvoid': 'üåê'
            };
            return icons[service] || 'üîë';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showMessage(message, type) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            const colors = {
                success: 'bg-green-900 border-green-500 text-green-300',
                error: 'bg-red-900 border-red-500 text-red-300',
                info: 'bg-blue-900 border-blue-500 text-blue-300'
            };

            messageDiv.className = `${colors[type]} border rounded-lg p-3 shadow-lg max-w-sm`;
            messageDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-xl">√ó</button>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);

            // Auto-suppression apr√®s 5 secondes
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Fonctions avanc√©es (√† impl√©menter)
        function testAllApis() {
            showMessage('Test des APIs en cours...', 'info');
            // TODO: Impl√©menter le test de toutes les APIs
        }

        function exportConfig() {
            showMessage('Export de la configuration...', 'info');
            // TODO: Impl√©menter l'export
        }
    </script>
</body>
</html>
