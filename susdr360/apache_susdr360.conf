# Configuration Apache pour SUSDR 360
# Fichier: /etc/apache2/sites-available/susdr360.conf

<VirtualHost *:80>
    ServerName 172.20.200.54
    DocumentRoot /opt/susdr360/app
    DirectoryIndex dashboard.php index.php index.html
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/susdr360_error.log
    CustomLog ${APACHE_LOG_DIR}/susdr360_access.log combined
    
    # Sécurité de base
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    
    # Configuration du répertoire racine
    <Directory /opt/susdr360/app>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Réécriture pour le dashboard principal
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ dashboard.php?$1 [QSA,L]
    </Directory>
    
    # API SUSDR 360 - Proxy vers FastAPI
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Configuration des timeouts pour les proxies
    ProxyTimeout 300
    
    # API endpoints
    ProxyPass /api/ http://127.0.0.1:8000/
    ProxyPassReverse /api/ http://127.0.0.1:8000/
    
    # Health check direct
    ProxyPass /health http://127.0.0.1:8000/health
    ProxyPassReverse /health http://127.0.0.1:8000/health
    
    # Interface web SUSDR 360
    ProxyPass /susdr360/ http://127.0.0.1:8000/
    ProxyPassReverse /susdr360/ http://127.0.0.1:8000/
    
    # Documentation API
    ProxyPass /docs http://127.0.0.1:8000/docs
    ProxyPassReverse /docs http://127.0.0.1:8000/docs
    
    # Configuration PHP
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/var/run/php/php7.4-fpm.sock|fcgi://localhost"
    </FilesMatch>
    
    # Fichiers statiques avec cache
    <LocationMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </LocationMatch>
    
    # Sécurité - Bloquer l'accès aux fichiers sensibles
    <DirectoryMatch "/\.">
        Require all denied
    </DirectoryMatch>
    
    <DirectoryMatch "/(config|cache|logs|scripts)/">
        Require all denied
    </DirectoryMatch>
    
    # Gestion des erreurs personnalisées
    ErrorDocument 404 /404.html
    ErrorDocument 500 /50x.html
    ErrorDocument 502 /50x.html
    ErrorDocument 503 /50x.html
    ErrorDocument 504 /50x.html
</VirtualHost>

# Configuration HTTPS (si certificat SSL disponible)
# <VirtualHost *:443>
#     ServerName 172.20.200.54
#     DocumentRoot /opt/susdr360/app
#     
#     SSLEngine on
#     SSLCertificateFile /path/to/certificate.crt
#     SSLCertificateKeyFile /path/to/private.key
#     
#     # Même configuration que ci-dessus
# </VirtualHost>
